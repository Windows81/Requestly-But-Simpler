!function(){"use strict";const e="GET_STORAGE_INFO",t="GET_STORAGE_SUPER_OBJECT",n="GET_STORAGE_OBJECT",o="SAVE_STORAGE_OBJECT",i="REMOVE_STORAGE_OBJECT",s="CLEAR_STORAGE",a="getTabSession",r="handshakeClient",c="getAPIResponse",d="startRecordingOnUrl",u="stopRecording",E="watchRecording",g="checkIfExtensionEnabled",l="cacheRecordedSessionOnPageUnload",m="initSessionRecorder",p="clientPageLoaded",R="notifyTestRuleReportUpdated",S="testRuleOnUrl",w="ruleSaveError",T="isProxyApplied",h="disconnectFromDesktopApp",y="desktopAppConnectionStatusUpdated",A="notifySessionRecordingStarted",L="notifySessionRecordingStopped",v="isRecordingSession",_="getTabSession",O="startRecording",I="stopRecording",C="isExplicitRecordingSession",f="notifyPageLoadedFromCache",M="notifyRecordUpdated",P="notifyExtensionStatusUpdated",D="local";var q,U,N,b,x,k,G,H,B,W,F,J;!function(e){e.GROUP="group",e.RULE="rule"}(q||(q={})),function(e){e.ACTIVE="Active",e.INACTIVE="Inactive"}(U||(U={})),function(e){e.REDIRECT="Redirect",e.CANCEL="Cancel",e.REPLACE="Replace",e.HEADERS="Headers",e.USERAGENT="UserAgent",e.SCRIPT="Script",e.QUERYPARAM="QueryParam",e.RESPONSE="Response",e.REQUEST="Request",e.DELAY="Delay"}(N||(N={})),function(e){e.URL="Url",e.HOST="host",e.PATH="path"}(b||(b={})),function(e){e.EQUALS="Equals",e.CONTAINS="Contains",e.MATCHES="Matches",e.WILDCARD_MATCHES="Wildcard_Matches"}(x||(x={})),function(e){e.PAGE_DOMAINS="pageDomains",e.REQUEST_METHOD="requestMethod",e.RESOURCE_TYPE="resourceType",e.REQUEST_PAYLOAD="requestPayload"}(k||(k={})),function(e){e.XHR="xmlhttprequest",e.JS="script",e.CSS="stylesheet",e.Image="image",e.Media="media",e.Font="font",e.WebSocket="websocket",e.MainDocument="main_frame",e.IFrameDocument="sub_frame"}(G||(G={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.PATCH="PATCH",e.OPTIONS="OPTIONS",e.CONNECT="CONNECT",e.HEAD="HEAD"}(H||(H={})),function(e){e.CUSTOM="custom",e.ALL_PAGES="allPages"}(B||(B={})),function(e){e.SESSION_RECORDING_CONFIG="sessionRecordingConfig"}(W||(W={})),function(e){e.JS="js",e.CSS="css"}(F||(F={})),function(e){e.URL="url",e.CODE="code"}(J||(J={}));var Q={browser:"edge",storageType:"local",contextMenuContexts:["browser_action"],env:"prod",WEB_URL:"https://app.requestly.io",SESSIONS_URL:"https://app.requestly.io/sessions",OTHER_WEB_URLS:["https://app.requestly.com","https://requestly.com"],LANDING_PAGE_BASE_URL:"https://requestly.com",logLevel:"info"};const X=async()=>new Promise((e=>{chrome.storage[D].get(null,e)})),Y=async e=>{await chrome.storage[D].set(e)},V=async e=>new Promise((t=>{chrome.storage[D].get(e,(n=>t(n[e])))}));var j,$;!function(e){e[e.MODIFIED=0]="MODIFIED",e[e.CREATED=1]="CREATED",e[e.DELETED=2]="DELETED"}(j||(j={})),function(e){e.IS_EXTENSION_ENABLED="isExtensionEnabled"}($||($={}));const z=e=>`rq_var_${e}`,K=async(e,t)=>{await(async(e,t)=>{await Y({[e]:t})})(z(e),t)},Z=async(e,t)=>await V(z(e))??t,ee=()=>{const e=new Set([]);return[...new Set([Q.WEB_URL,...Q.OTHER_WEB_URLS])].forEach((t=>{const n=new URL(t).origin;e.add(n)})),[...e]},te={};const ne="content_script",oe="page_script",ie="source",se=(e,t)=>{e.action&&(t&&((e,t)=>{if(!t)return;te[e.action+"_1"]=t,e.requestId=1})(e,t),e[ie]=ne,window.postMessage(e,window.origin))},ae=(e,t)=>{se({action:e.action,requestId:e.requestId,response:t})},re=async()=>{const e=await Z($.IS_EXTENSION_ENABLED);await(async()=>{await chrome.storage[D].clear()})(),void 0!==e&&await K($.IS_EXTENSION_ENABLED,e)},ce=e=>"undefined"!=typeof cloneInto?cloneInto(e,window):e,de={};let ue=!1;const Ee={isRecording:!1,isExplicitRecording:!1,markRecordingIcon:!1,widgetPosition:null,recordingStartTime:null,showWidget:!1},ge=()=>{window.addEventListener("pageshow",(e=>{e.persisted&&chrome.runtime.sendMessage({action:f,payload:{isRecordingSession:Ee.isRecording}})}))},le=async e=>{if(!e)return;await(async()=>new Promise((e=>{ue&&e(),chrome.runtime.sendMessage({action:m},(()=>{ue=!0,e()}))})))();const{notify:t,markRecordingIcon:n=!0,explicit:o=!1,recordingStartTime:i=Date.now(),showWidget:s,widgetPosition:a,previousSession:r}=e,c=window.top!==window;c||me(),Re("startRecording",{relayEventsToTop:c,console:!0,network:!0,maxDuration:60*(e.maxDuration||5)*1e3,previousSession:c?null:r,localStorage:!0}),Ee.isExplicitRecording=o,Ee.markRecordingIcon=n,Ee.showWidget=s,Ee.widgetPosition=a,Ee.recordingMode=o?"manual":"auto",t&&Ae(),o&&(Ee.recordingStartTime=i,ye())},me=()=>{chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case v:n(Ee.isRecording);break;case _:return Re("getSessionData",null,(e=>{n({...e,recordingMode:Ee.recordingMode})})),!0;case C:n(Ee.isExplicitRecording);break;case I:Re("stopRecording",null)}return!1})),window.addEventListener("message",(function(e){e.source===window&&"requestly:client"===e.data.source&&(e.data.response?pe(e.data.action,e.data.payload):"sessionRecordingStarted"===e.data.action?(Ee.isRecording=!0,chrome.runtime.sendMessage({action:A,payload:{markRecordingIcon:Ee.markRecordingIcon}}),Ee.showWidget&&(Ee.isExplicitRecording?Se():he())):"sessionRecordingStopped"===e.data.action&&(Ee.isRecording=!1,Ee.isExplicitRecording=!1,Ee.markRecordingIcon=!1,we(),ye(),chrome.runtime.sendMessage({action:L})))})),window.addEventListener("beforeunload",(()=>{Re("getSessionData",null,(e=>{chrome.runtime.sendMessage({action:l,payload:{session:e,widgetPosition:Ee.widgetPosition,recordingMode:Ee.recordingMode,recordingStartTime:Ee.recordingStartTime}})}))}))},pe=(e,t)=>{de[e]?.(t),delete de[e]},Re=(e,t,n)=>{window.postMessage({source:"requestly:extension",action:e,payload:t},window.location.href),n&&(de[e]=n)},Se=()=>{let e=Te();e||(e=document.createElement("rq-session-recording-widget"),e.classList.add("rq-element"),document.documentElement.appendChild(e),e.addEventListener("stop",(()=>{chrome.runtime.sendMessage({action:u,openRecording:!0})})),e.addEventListener("discard",(()=>{chrome.runtime.sendMessage({action:u})})),e.addEventListener("moved",(e=>{Ee.widgetPosition=e.detail})));const t=Date.now()-Ee.recordingStartTime,n=t<=3e5?t:null;e.dispatchEvent(new CustomEvent("show",ce({detail:{currentRecordingTime:n,position:Ee.widgetPosition}})))},we=()=>{const e=Te();e?.dispatchEvent(new CustomEvent("hide"))},Te=()=>document.querySelector("rq-session-recording-widget"),he=()=>{const e="rq-session-recording-auto-mode-widget";let t=document.querySelector(e);t||(t=document.createElement(e),t.classList.add("rq-element"),document.documentElement.appendChild(t),t.addEventListener("watch",(()=>{chrome.runtime.sendMessage({action:E})})),t.addEventListener("moved",(e=>{Ee.widgetPosition=e.detail}))),t.dispatchEvent(new CustomEvent("show",ce({detail:{position:Ee.widgetPosition}})))},ye=()=>{let e=document.querySelector("rq-session-recording-auto-mode-widget");e?.dispatchEvent(new CustomEvent("hide"))},Ae=()=>{const e=document.createElement("rq-toast");e.classList.add("rq-element"),e.setAttribute("heading","Requestly is recording session on this tab!"),e.setAttribute("icon-path",chrome.runtime.getURL("resources/images/128x128.png"));const t='\n  <div slot="content">\n    You can save up to last 5 minutes anytime by clicking on Requestly extension icon to save & upload activity for this tab.\n  </div>\n  ';try{e.innerHTML=t}catch(n){const o=window.trustedTypes?.createPolicy?.("rq-html-policy",{createHTML:e=>e});e.innerHTML=o.createHTML(t)}document.documentElement.appendChild(e)};document.documentElement.setAttribute("rq-ext-version",chrome.runtime.getManifest().version),document.documentElement.setAttribute("rq-ext-mv","3"),document.documentElement.setAttribute("rq-ext-id",chrome.runtime.id),window.addEventListener("message",(async r=>{var u;if((!r||(e=>{let t=null;try{t=new URL(e).origin}catch(e){return!1}return!!e&&ee().includes(t)})(r.origin))&&r&&r.data&&r.data.source===oe)switch(void 0!==r.data.response&&(e=>{const t=te[e.data.action+"_"+e.data.requestId];"function"==typeof t&&(delete te[e.data.action],t(e.data.response))})(r),r.data.action){case e:{const e=await(async()=>{const e=await X();return Object.values(e).filter((e=>!!e))})();return void ae(r.data,{storageType:D,numItems:e.length,bytesUsed:JSON.stringify(e).length})}case t:{const e=await X();return void ae(r.data,e)}case n:{const e=await V(r.data.key);return void ae(r.data,e)}case o:return await Y(r.data.object),void ae(r.data);case i:return await(async e=>{await chrome.storage[D].remove(e)})(r.data.key),void ae(r.data);case s:return await re(),void ae(r.data);case a:case c:case d:case S:case T:case h:case g:u=r.data,chrome.runtime.sendMessage(u,(e=>{ae(u,e)}))}})),chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case p:chrome.runtime.sendMessage({action:p});break;case R:case M:case w:case y:case P:se(e)}})),(async()=>await Z($.IS_EXTENSION_ENABLED,!0))().then((e=>{e&&(chrome.runtime.sendMessage({action:r}),chrome.runtime.onMessage.addListener((e=>{e.action===O&&le(e.payload)})),ge())}))}();
